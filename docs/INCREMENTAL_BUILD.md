# å¢é‡ç´¢å¼•æ„å»º - Incremental Index Build

## ğŸ“‹ æ¦‚è¿°

å¢é‡ç´¢å¼•æ„å»ºåŠŸèƒ½å…è®¸æˆ‘ä»¬æ‰©å±•ç°æœ‰çš„FAISSç´¢å¼•ï¼Œè€Œæ— éœ€é‡æ–°æ„å»ºæ•´ä¸ªç´¢å¼•ã€‚è¿™å¯¹äºå¤„ç†æ–°æ–‡æ¡£å’Œä¿æŒç´¢å¼•æœ€æ–°çŠ¶æ€éå¸¸æœ‰ç”¨ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- **æ™ºèƒ½æ—¶é—´æˆ³æ£€æµ‹**: è‡ªåŠ¨ä»ç°æœ‰chunkså…ƒæ•°æ®ä¸­ç¡®å®š`since_ts`
- **å¢é‡æ–‡æ¡£è·å–**: åªè·å–æ¯”ç°æœ‰ç´¢å¼•æ›´æ–°çš„æ–‡æ¡£
- **æ— ç¼åˆå¹¶**: å°†æ–°æ–‡æ¡£ä¸ç°æœ‰ç´¢å¼•åˆå¹¶
- **ç‰ˆæœ¬åŒ–ç®¡ç†**: åˆ›å»ºæ–°çš„ç‰ˆæœ¬åŒ–ç´¢å¼•æ–‡ä»¶
- **åŸå­æ›´æ–°**: é€šè¿‡`latest.json`æŒ‡é’ˆå®ç°åŸå­åˆ‡æ¢

### æ€§èƒ½ä¼˜åŒ–
- **å€™é€‰è¿‡æ»¤**: ä½¿ç”¨æ—¶é—´çª—å£é™åˆ¶DynamoDBæ‰«ææˆæœ¬
- **åˆ†é¡µå¤„ç†**: æ”¯æŒå¤§é‡æ–‡æ¡£çš„åˆ†é¡µå¤„ç†
- **å†…å­˜æ•ˆç‡**: æµå¼å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º
- **å¹¶è¡ŒåµŒå…¥**: æ‰¹é‡åµŒå…¥æ–°æ–‡æ¡£

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# å¢é‡æ„å»ºï¼ˆæ¨èï¼‰
python scripts/build_index_incremental.py --limit 1000

# å¹²è¿è¡Œæ¨¡å¼ï¼ˆæŸ¥çœ‹ä¼šæ·»åŠ ä»€ä¹ˆï¼‰
python scripts/build_index_incremental.py --dry-run true --limit 100

# å¸¦æ—¶é—´çª—å£é™åˆ¶ï¼ˆæ§åˆ¶æˆæœ¬ï¼‰
python scripts/build_index_incremental.py --window-days 7 --limit 500
```

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--dry-run` | `false` | å¹²è¿è¡Œæ¨¡å¼ï¼Œä¸å®é™…åˆ›å»ºç´¢å¼• |
| `--limit` | `2000` | æœ€å¤§å¤„ç†çš„æ–°æ–‡æ¡£æ•°é‡ |
| `--region` | `us-east-2` | AWSåŒºåŸŸ |
| `--bucket` | `fin-news-raw-yz` | S3å­˜å‚¨æ¡¶åç§° |
| `--table` | `news_documents` | DynamoDBè¡¨å |
| `--prefix` | `polygon/` | S3å‰ç¼€ |
| `--window-days` | `None` | æ—¶é—´çª—å£å¤©æ•°ï¼ˆé™åˆ¶æ‰«ææˆæœ¬ï¼‰ |
| `--min-body-chars` | `400` | æœ€å°æ­£æ–‡é•¿åº¦ |

### ä½¿ç”¨ç¤ºä¾‹

#### 1. æ—¥å¸¸å¢é‡æ›´æ–°
```bash
# å¤„ç†æœ€è¿‘çš„æ–°æ–‡æ¡£
python scripts/build_index_incremental.py --limit 500 --window-days 3
```

#### 2. å¤§æ‰¹é‡æ›´æ–°
```bash
# å¤„ç†å¤§é‡æ–°æ–‡æ¡£
python scripts/build_index_incremental.py --limit 5000
```

#### 3. æµ‹è¯•å’ŒéªŒè¯
```bash
# å¹²è¿è¡ŒæŸ¥çœ‹ä¼šæ·»åŠ ä»€ä¹ˆ
python scripts/build_index_incremental.py --dry-run true --limit 100

# è¿è¡Œæµ‹è¯•å¥—ä»¶
python scripts/test_incremental_build.py
```

## ğŸ”§ æŠ€æœ¯å®ç°

### å·¥ä½œæµç¨‹

1. **è·å–å½“å‰ç‰ˆæœ¬**
   - ä¸‹è½½`latest.json`æŒ‡é’ˆ
   - è·å–å½“å‰manifestä¿¡æ¯
   - ç¡®å®šç°æœ‰ç´¢å¼•çŠ¶æ€

2. **ç¡®å®šæ—¶é—´æˆ³**
   - ä»ç°æœ‰chunkså…ƒæ•°æ®ä¸­æå–æ—¶é—´æˆ³
   - é€‰æ‹©`published_utc`å’Œ`fetched_at`çš„æœ€å¤§å€¼
   - ä½œä¸º`since_ts`ç”¨äºè¿‡æ»¤æ–°æ–‡æ¡£

3. **è·å–æ–°æ–‡æ¡£**
   - æ‰«æDynamoDBè¡¨
   - è¿‡æ»¤æ¡ä»¶ï¼š`published_utc > since_ts OR fetched_at > since_ts`
   - æ”¯æŒæ—¶é—´çª—å£é™åˆ¶

4. **å¤„ç†æ–°æ–‡æ¡£**
   - æ­£æ–‡é€‰æ‹©ï¼šä¼˜å…ˆä½¿ç”¨`body`å­—æ®µï¼Œå¦åˆ™ä»S3è·å–
   - æ­£æ–‡æ¸…ç†ï¼šä½¿ç”¨`clean_body()`å‡½æ•°
   - æ–‡æœ¬åˆ†å—ï¼šä½¿ç”¨`TextChunker`ï¼ˆ360/460/40/200å‚æ•°ï¼‰
   - æ–‡æœ¬åµŒå…¥ï¼šä½¿ç”¨`TextEmbedder`ï¼ˆMiniLMï¼Œnormalize=Trueï¼‰

5. **åˆå¹¶ç´¢å¼•**
   - åŠ è½½ç°æœ‰embeddingsçŸ©é˜µ
   - è¿½åŠ æ–°embeddings
   - åˆå¹¶chunkså…ƒæ•°æ®
   - é‡æ–°åˆ†é…row_index

6. **æ„å»ºæ–°ç´¢å¼•**
   - åˆ›å»ºæ–°çš„`IndexFlatIP`
   - æ·»åŠ æ‰€æœ‰embeddings
   - éªŒè¯ç´¢å¼•å®Œæ•´æ€§

7. **ç‰ˆæœ¬åŒ–ç®¡ç†**
   - ç”Ÿæˆæ–°ç‰ˆæœ¬å·ï¼ˆYYYYMMDD_HHMMSSæ ¼å¼ï¼‰
   - å†™å…¥ç‰ˆæœ¬åŒ–æ–‡ä»¶åˆ°æœ¬åœ°
   - ä¸Šä¼ åˆ°S3
   - æ›´æ–°`latest.json`æŒ‡é’ˆ

### æ•°æ®ç»“æ„

#### è¾“å…¥æ•°æ®ï¼ˆDynamoDBï¼‰
```json
{
  "doc_id": "string",
  "title": "string", 
  "body": "string",
  "source": "polygon",
  "published_utc": "2025-08-21T10:00:00Z",
  "fetched_at": "2025-08-21T10:05:00Z",
  "tickers": ["NVDA", "AAPL"],
  "url": "https://example.com/news",
  "s3_key": "polygon/news_123.txt"
}
```

#### è¾“å‡ºæ•°æ®ï¼ˆS3ï¼‰
```
s3://fin-news-raw-yz/faiss/{version}/
â”œâ”€â”€ index.faiss          # FAISSç´¢å¼•æ–‡ä»¶
â”œâ”€â”€ chunks.parquet       # å…ƒæ•°æ®ï¼ˆParquetæ ¼å¼ï¼‰
â”œâ”€â”€ chunks.csv           # å…ƒæ•°æ®ï¼ˆCSVæ ¼å¼ï¼Œfallbackï¼‰
â”œâ”€â”€ embeddings.npy       # åµŒå…¥çŸ©é˜µ
â””â”€â”€ manifest.json        # æ¸…å•æ–‡ä»¶
```

#### æ¸…å•æ–‡ä»¶æ ¼å¼
```json
{
  "version": "20250901_230211",
  "created_at_utc": "2025-09-01T23:02:11Z",
  "bucket": "fin-news-raw-yz",
  "region": "us-east-2",
  "index_key": "faiss/20250901_230211/index.faiss",
  "chunks_key": "faiss/20250901_230211/chunks.parquet",
  "emb_key": "faiss/20250901_230211/embeddings.npy",
  "ntotal": 527,
  "dim": 384
}
```

## ğŸ“Š æ€§èƒ½ç‰¹å¾

### å¤„ç†é€Ÿåº¦
- **æ–‡æ¡£æ‰«æ**: ~100-500 docs/sï¼ˆå–å†³äºè¿‡æ»¤æ¡ä»¶ï¼‰
- **æ–‡æœ¬åˆ†å—**: ~50-100 docs/s
- **æ–‡æœ¬åµŒå…¥**: ~20-50 chunks/s
- **ç´¢å¼•æ„å»º**: ~1000-5000 vectors/s
- **S3ä¸Šä¼ **: ~10-50 MB/s

### èµ„æºä½¿ç”¨
- **å†…å­˜**: çº¿æ€§å¢é•¿ï¼Œå–å†³äºæ–°æ–‡æ¡£æ•°é‡
- **CPU**: ä¸»è¦æ¶ˆè€—åœ¨åµŒå…¥å’Œç´¢å¼•æ„å»º
- **ç½‘ç»œ**: S3ä¸Šä¼ /ä¸‹è½½ï¼ŒDynamoDBæ‰«æ

### å…¸å‹æ€§èƒ½
```
å¤„ç†1000ä¸ªæ–°æ–‡æ¡£:
- æ‰«ææ—¶é—´: 10-30ç§’
- å¤„ç†æ—¶é—´: 30-60ç§’  
- åµŒå…¥æ—¶é—´: 20-50ç§’
- ç´¢å¼•æ„å»º: 5-10ç§’
- ä¸Šä¼ æ—¶é—´: 10-30ç§’
- æ€»æ—¶é—´: 75-180ç§’
```

## ğŸ› ï¸ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

#### 1. DynamoDBæ‰«æé”™è¯¯
```
Error: Parameter validation failed
Solution: æ£€æŸ¥è¡¨åå’ŒåŒºåŸŸé…ç½®
```

#### 2. S3ä¸‹è½½å¤±è´¥
```
Error: Failed to download latest.json
Solution: æ£€æŸ¥S3æƒé™å’Œæ–‡ä»¶å­˜åœ¨æ€§
```

#### 3. åµŒå…¥å¤±è´¥
```
Error: TextEmbedder initialization failed
Solution: æ£€æŸ¥æ¨¡å‹ä¸‹è½½å’Œä¾èµ–å®‰è£…
```

#### 4. ç´¢å¼•æ„å»ºå¤±è´¥
```
Error: FAISS index creation failed
Solution: æ£€æŸ¥embeddingsçŸ©é˜µç»´åº¦å’Œæ•°æ®ç±»å‹
```

### æ¢å¤ç­–ç•¥
- **éƒ¨åˆ†å¤±è´¥**: è„šæœ¬ä¼šè®°å½•é”™è¯¯å¹¶ç»§ç»­å¤„ç†
- **å®Œå…¨å¤±è´¥**: ç°æœ‰ç´¢å¼•ä¿æŒä¸å˜ï¼Œå¯ä»¥é‡è¯•
- **æ•°æ®ä¸ä¸€è‡´**: ä½¿ç”¨`latest.json`å›æ»šåˆ°ä¹‹å‰ç‰ˆæœ¬

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—è¾“å‡º
```
INFO:__main__:Current version: 20250828_002747
INFO:__main__:Current index: 511 vectors, 384 dimensions
INFO:__main__:Found since timestamp: 2025-08-26T01:14:00Z
INFO:__main__:Scanned 10 items, found 10 new documents
INFO:__main__:Processed 10 documents into 26 chunks
INFO:__main__:Embedded 26 chunks in 1.24s (21.0 chunks/s)
INFO:__main__:Merged embeddings: (537, 384)
INFO:__main__:Built new index: 537 vectors, 384 dimensions
```

### ç»Ÿè®¡ä¿¡æ¯
```
INCREMENTAL BUILD COMPLETED SUCCESSFULLY
Version: 20250901_230211
Old total: 511
New added: 16
New total: 527
Total time: 3.52s
```

### è°ƒè¯•æŠ€å·§
1. **ä½¿ç”¨dry-runæ¨¡å¼**: æŸ¥çœ‹ä¼šå¤„ç†å“ªäº›æ–‡æ¡£
2. **é™åˆ¶æ–‡æ¡£æ•°é‡**: ä½¿ç”¨`--limit`å‚æ•°è¿›è¡Œå°è§„æ¨¡æµ‹è¯•
3. **æ£€æŸ¥æ—¥å¿—**: å…³æ³¨é”™è¯¯å’Œè­¦å‘Šä¿¡æ¯
4. **éªŒè¯ç»“æœ**: ä½¿ç”¨`check_faiss_index.py`éªŒè¯ç´¢å¼•çŠ¶æ€

## ğŸ”„ ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆ

### æœç´¢æœåŠ¡è‡ªåŠ¨æ›´æ–°
- æœç´¢æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½æœ€æ–°ç´¢å¼•
- æ— éœ€æ‰‹åŠ¨é‡å¯æœåŠ¡
- æ”¯æŒçƒ­æ›´æ–°

### ç‰ˆæœ¬ç®¡ç†
- æ¯ä¸ªå¢é‡æ„å»ºåˆ›å»ºæ–°ç‰ˆæœ¬
- ä¿ç•™å†å²ç‰ˆæœ¬ç”¨äºå›æ»š
- é€šè¿‡`latest.json`å®ç°åŸå­åˆ‡æ¢

### ç›‘æ§é›†æˆ
- å¯ä»¥é›†æˆåˆ°CI/CDæµæ°´çº¿
- æ”¯æŒå®šæ—¶ä»»åŠ¡è°ƒåº¦
- æä¾›è¯¦ç»†çš„æ‰§è¡ŒæŠ¥å‘Š

## ğŸš€ æœ€ä½³å®è·µ

### 1. å®šæœŸå¢é‡æ›´æ–°
```bash
# æ¯æ—¥å¢é‡æ›´æ–°
0 2 * * * python scripts/build_index_incremental.py --limit 1000 --window-days 1
```

### 2. æˆæœ¬æ§åˆ¶
```bash
# ä½¿ç”¨æ—¶é—´çª—å£é™åˆ¶æ‰«ææˆæœ¬
python scripts/build_index_incremental.py --window-days 7 --limit 500
```

### 3. æµ‹è¯•å’ŒéªŒè¯
```bash
# å…ˆè¿›è¡Œå¹²è¿è¡Œ
python scripts/build_index_incremental.py --dry-run true --limit 100

# ç„¶åæ‰§è¡Œå®é™…æ„å»º
python scripts/build_index_incremental.py --limit 100
```

### 4. ç›‘æ§å’Œå‘Šè­¦
- ç›‘æ§æ„å»ºæ—¶é—´å’ŒæˆåŠŸç‡
- è®¾ç½®å¤±è´¥å‘Šè­¦
- è·Ÿè¸ªç´¢å¼•å¤§å°å¢é•¿

## ğŸ“ˆ æœªæ¥æ”¹è¿›

### è®¡åˆ’åŠŸèƒ½
1. **å¢é‡åˆ é™¤**: æ”¯æŒåˆ é™¤è¿‡æ—¶æ–‡æ¡£
2. **å¹¶è¡Œå¤„ç†**: å¤šè¿›ç¨‹å¹¶è¡Œå¤„ç†æ–‡æ¡£
3. **æ™ºèƒ½è°ƒåº¦**: åŸºäºæ–‡æ¡£æ•°é‡è‡ªåŠ¨è°ƒæ•´å‚æ•°
4. **å‹ç¼©ä¼˜åŒ–**: å‹ç¼©å†å²ç‰ˆæœ¬èŠ‚çœå­˜å‚¨
5. **å®æ—¶æ›´æ–°**: æ”¯æŒå®æ—¶æ–‡æ¡£æµå¤„ç†

### æ€§èƒ½ä¼˜åŒ–
1. **ç¼“å­˜æœºåˆ¶**: ç¼“å­˜å¸¸ç”¨æ•°æ®å‡å°‘é‡å¤è®¡ç®—
2. **æ‰¹é‡ä¼˜åŒ–**: ä¼˜åŒ–æ‰¹é‡æ“ä½œæ€§èƒ½
3. **å†…å­˜ç®¡ç†**: æ”¹è¿›å†…å­˜ä½¿ç”¨æ•ˆç‡
4. **ç½‘ç»œä¼˜åŒ–**: ä¼˜åŒ–S3ä¼ è¾“æ€§èƒ½

---

*æœ€åæ›´æ–°: 2025-01-28 - å¢é‡æ„å»ºåŠŸèƒ½å®ç°å®Œæˆ*
